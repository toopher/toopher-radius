Installing and Configuring the Toopher RADIUS server
======================================================

Toopher uses the popular open-source FreeRadius server as the base for its RADIUS
solution.

Set Up LDAP Integration
-----------------------
Integrating Toopher into your organization's LDAP schema provides a simple way to administer per-user Toopher settings,
and is the recommended deployment method. 

### Prepare the Active Directory / LDAP Server for Toopher Administration
On the LDAP server, create a group called `ToopherUsers`

In addition, if your LDAP server is not configured to allow anonymous search, you should create a user LDAP account that has `search` permission for the `sAMAccountName` attribute (if using Active Directory), or `uid` (for most other LDAP schemas).


Installing the RADIUS Server
-----------------------------
### Installing on Ubuntu (or other debian-based distro)
ensure that the OS is updated, the `build-essential` package is installed, and `CPAN` in up-to-date:

    sudo apt-get update
    sudo apt-get upgrade
    sudo apt-get install build-essential
    sudo cpan CPAN

run the provided install-ubuntu.sh script as root:

    cd linux && sudo ./install-ubuntu.sh

If the installation script stalls on a CPAN step, you may need to update the CPAN mirror list in the cpan shell:

    sudo cpan
    cpan> o conf init urllist
    cpan> o conf commit
    cpan> exit

### Installing on other linux
Automated install scripts for Redhat and SuSE distros should be available soon.  Please contact support@toopher.com if you need accelerated access to installers for alternate distributions.

### Installing on Windows
Please use our prebuilt Cygwin-based server for deployment on Windows.

RADIUS Configuration
--------------------
Add the IP address of your VPN solution to /etc/raddb/clients.conf.  This will vary according to your network environment.  As an example, to add a VPN client named `PA_VM` accessiable at local IP address of `172.16.42.201` with RADIUS secret `s3cr3t`, add the following four lines to `clients.conf`: 

   client PA_VM {
        ipaddr = 172.16.42.201
        secret = s3cr3t
   }


Before you can run the server, you need to edit /etc/freeradius/toopher_radius_config.pm to suit your site.
```perl
    my $toopher_config =
    {
      toopher_api => {
        url   =>  'https://api.toopher.com.com/v1/',
        key   =>  'YOUR TOOPHER API KEY',
        secret=>  'YOUR TOOPHER API SECRET',
        },
      prompts => {
        pairing_challenge => 'Toopher 2-factor authentication is enabled for your account.  Please enter the pairing phrase generated by the Toopher mobile app:',
        otp_challenge => 'Timeout while contacting the Toopher API.  Please enter the OTP generated by the Toopher Mobile App to proceed.',
        }
    };
```

At a minimum, you must change the "key" and "secret" values in the
toopher_api section.  You can generate new requester credentials at the 
[Toopher Developer Site](https://dev.toopher.com).

Additionally, edit /etc/freeradius/modules/ldap to point to your LDAP / Active Directory server
```conf
    ldap {
        server = "192.168.1.201"
        identity = "cn=radius_admin,cn=users,DC=myexample,DC=toopher,DC=com"
        password = p@ssw0rd
        basedn = "cn=users,DC=example,DC=toopher,DC=com"
        filter = "(|(uid=%{%{Stripped-User-Name}:-%{User-Name}})(sAMAccountName=%{%{Stripped-User-Name}:-%{User-Name}}))"
        groupname_attribute = cn
        groupmembership_filter = "(|(&(objectClass=GroupOfNames)(member=%{control:Ldap-UserDn}))(&(objectClass=GroupOfUniqueNames)(uniquemember=%{control:Ldap-UserDn}))(&(objectClass=group)(member=%{control:Ldap-UserDn})))"

        # LOTS OF OTHER SETTINGS
    }
```
Most users will only need to edit the `server`, `identity`, `password`, and `basedn` settings.  `identity` and `password` correspond to an LDAP account that is allowed `search`/`read` access to `User` objects.  If your LDAP server permits anonymous searches, you can comment out these two lines.

The default filters should work for Active Directory, as well as any LDAP server using the [RFC 2798 (inetOrgPerson)](http://tools.ietf.org/html/rfc2798) schema.

Additionally, you may customize the prompt displayed to users when they initially pair their device with Toopher.  The maximum length of this prompt is 253 characters due to technical limitations of the RADIUS specification.

Start the RADIUS server
-----------------------

    sudo service freeradius start    # or service radiusd start, depending on the distro

Add Toopher Protection to Individual Users
------------------------------------------

Toopher is enabled/disabled for an individual user by adding or removing that user from the `ToopherUsers` LDAP group.  Users who are members of `ToopherUsers` will be subject to an additional Toopher Authentication step before being allowed access via RADIUS.

Resetting a User's Pairing
-----------------------------------
Resetting a pairing is occasionally necessary, for instance if a user gets a new mobile device and wants to stop authenticating with their old device.  

Users can reset their pairing from their mobile device through the Toopher Mobile App by selecting the pairing on the main screen, then pressing "Remove Pairing".  The user will be prompted to re-pair with a new mobile device the next time they authenticate with the Toopher-RADIUS server.

In some cases, a user may require administrator assistance to recover a lost pairing.  This most commonly happens if the user uninstalls the Toopher app, or loses their mobile device.  There are two options for restoring access to the user:

* Remove the user from the `ToopherUsers` LDAP group - This will preserve the Pairing informaion in the Toopher API server, while allowing the user to bypass Toopher authentication to log in.  This method can be effectively undone by adding the user back to the `ToopherUsers` group.
* Reset the user's pairing - Administrators can reset a user's pairing information by running `perl /etc/freeradius/toopher_radius.pl reset-pairing [username]` on the Toopher-RADIUS server.  This command will remove that user's pairing information from the Toopher API, and they will be prompted to re-pair the next time they authenticate.

